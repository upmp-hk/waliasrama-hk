<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Rekap Santri Sakit Harian & Bulanan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --blue: #2563eb;
      --blue-soft: #dbeafe;
      --blue-soft2: #eff6ff;
      --green: #10b981;
      --green-soft: #dcfce7;
      --red: #ef4444;
      --gray-soft: #f3f4f6;
      --gray: #6b7280;
      --dark: #0f172a;
      --white: #ffffff;
      --radius-lg: 16px;
      --radius-xl: 22px;
      --shadow-soft: 0 14px 35px rgba(15, 23, 42, 0.18);
      --shadow-chip: 0 1px 4px rgba(15, 23, 42, 0.15);
    }

    html {
      font-size: 105%;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at top left, #bfdbfe 0, transparent 45%),
        radial-gradient(circle at bottom right, #bbf7d0 0, transparent 50%),
        linear-gradient(135deg, #e5f0ff, #e0f9ee);
      display: flex;
      justify-content: center;
      padding: 1rem;
      color: var(--dark);
    }

    .app {
      width: 100%;
      max-width: 1180px;
      background: rgba(255, 255, 255, 0.97);
      border-radius: 26px;
      box-shadow: var(--shadow-soft);
      padding: 1.25rem;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.15);
      backdrop-filter: blur(10px);
      animation: app-fade-in 0.35s ease-out;
    }

    @media (min-width: 768px) {
      .app {
        padding: 1.6rem 2rem 1.9rem;
      }
    }

    @keyframes app-fade-in {
      from {
        opacity: 0;
        transform: translateY(6px) scale(0.99);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* ===== HEADER BOX ===== */
    .header-box {
      border-radius: 20px;
      border: 1px solid rgba(209, 213, 219, 0.85);
      background:
        linear-gradient(135deg, #eff6ff, #ecfdf5);
      padding: 0.95rem 1.15rem;
      margin-bottom: 0.9rem;
      position: relative;
      overflow: hidden;
    }

    .header-box::after {
      content: "";
      position: absolute;
      right: -80px;
      top: -80px;
      width: 180px;
      height: 180px;
      border-radius: 999px;
      background: radial-gradient(circle at center, rgba(37, 99, 235, 0.23), transparent 70%);
      opacity: 0.6;
      pointer-events: none;
    }

    .header-inner {
      display: grid;
      grid-template-columns: auto;
      gap: 0.75rem;
      position: relative;
      z-index: 1;
    }

    @media (min-width: 768px) {
      .header-inner {
        grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
        align-items: center;
      }
    }

    .header-main {
      text-align: left;
    }

    .header-title-row {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      margin-bottom: 0.15rem;
    }

    .header-icon {
      width: 38px;
      height: 38px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.14);
      font-size: 1.3rem;
      flex-shrink: 0;
    }

    h1 {
      font-size: calc(1.25rem);
      font-weight: 700;
      color: var(--dark);
      letter-spacing: 0.01em;
      margin-bottom: 0;
      text-align: center;
    }

    .subtitle {
      font-size: calc(0.83rem);
      color: var(--gray);
      max-width: 540px;
      margin-top: 0.45rem;
    }

    .header-side {
      text-align: left;
      font-size: 0.75rem;
      color: var(--gray);
      display: grid;
      gap: 0.45rem;
    }

    .stat-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
    }

    .stat-chip {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.85);
      box-shadow: var(--shadow-chip);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .stat-chip strong {
      font-size: 0.78rem;
      color: #111827;
    }

    /* ===== TABS ===== */
    .tabs {
      display: inline-flex;
      gap: 0.35rem;
      margin-top: 0.55rem;
      border-radius: 999px;
      padding: 0.15rem;
      background: rgba(15, 23, 42, 0.03);
      border: 1px solid rgba(209, 213, 219, 0.9);
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 0.45rem 0.9rem;
      border-radius: 999px;
      font-size: calc(0.78rem);
      cursor: pointer;
      color: var(--gray);
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition:
        background 0.14s ease,
        color 0.14s ease,
        box-shadow 0.14s ease,
        transform 0.06s ease;
      white-space: nowrap;
    }

    .tab-btn.active {
      background: var(--white);
      color: #1d4ed8;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
      transform: translateY(-0.5px);
    }

    .tab-content {
      margin-top: 1rem;
    }

    .hidden {
      display: none !important;
    }

    /* ===== PANELS / FILTER ===== */
    .panel {
      border-radius: 18px;
      border: 1px solid rgba(209, 213, 219, 0.85);
      background: linear-gradient(145deg, #ffffff, #f9fafb);
      padding: 0.75rem 0.9rem 0.8rem;
      margin-bottom: 0.85rem;
    }

    .panel-header {
      display: flex;
      align-items: baseline;
      gap: 0.4rem;
      margin-bottom: 0.45rem;
    }

    .panel-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #111827;
    }

    .panel-caption {
      font-size: 0.72rem;
      color: var(--gray);
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: flex-end;
      margin-bottom: 0.3rem;
    }

    .filter-row-center {
      justify-content: center;
    }

    .filter-row-center-inner {
      display: flex;
      align-items: flex-end;
      gap: 0.75rem;
      width: 100%;
      max-width: 720px;
    }

    .filter-row-center-inner .field {
      flex: 1;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      font-size: 0.78rem;
      min-width: 110px;
    }

    .field label {
      color: var(--gray);
      font-size: 0.76rem;
      padding-top: 0.11rem;
      padding-bottom: 0.1rem;
      letter-spacing: 0.01em;
    }

    .field input,
    .field select {
      border-radius: 999px;
      border: 1px solid rgba(209, 213, 219, 0.9);
      padding: 0.42rem 0.7rem;
      font-size: 0.8rem;
      background: #f9fafb;
      outline: none;
      transition:
        border-color 0.12s ease,
        box-shadow 0.12s ease,
        background 0.12s ease,
        transform 0.06s ease;
    }

    .field input:focus,
    .field select:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
      background: #ffffff;
      transform: translateY(-0.5px);
    }

    /* === CHIP GROUP === */
    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .chip-option {
      border: none;
      border-radius: 999px;
      padding: 0.25rem 0.8rem;
      font-size: 0.78rem;
      cursor: pointer;
      background: #f3f4f6;
      color: #4b5563;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition:
        background 0.12s ease,
        color 0.12s ease,
        box-shadow 0.12s ease,
        transform 0.06s ease;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
    }

    .chip-option:hover {
      background: #e5e7eb;
      transform: translateY(-0.5px);
    }

    .chip-option.active {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #ffffff;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35);
    }

    /* ===== BUTTONS ===== */
    button {
      border: none;
      border-radius: 999px;
      padding: 0.48rem 1.1rem;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      transition:
        transform 0.08s ease,
        box-shadow 0.1s ease,
        background 0.15s ease,
        filter 0.15s ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    button:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: none;
      filter: brightness(0.98);
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.45);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.45);
    }

    .btn-outline {
      background: #ffffff;
      color: var(--dark);
      border: 1px solid #e5e7eb;
      box-shadow: 0 3px 10px rgba(15, 23, 42, 0.08);
    }

    .btn-danger {
      background: var(--red);
      color: white;
      box-shadow: 0 6px 16px rgba(248, 113, 113, 0.5);
    }

    .btn-ghost {
      background: transparent;
      color: var(--gray);
    }

    .icon {
      font-size: 0.92rem;
    }

    /* ===== TABLE ===== */
    .table-card {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(209, 213, 219, 0.9);
      overflow: hidden;
      background: #f9fafb;
      min-height: 220px;
    }

    .table-container {
      margin-top: 0.65rem;
    }

    .table-scroll {
      width: 100%;
      overflow-x: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.8) transparent;
    }

    .table-scroll::-webkit-scrollbar {
      height: 7px;
    }

    .table-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.9);
      border-radius: 999px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 520px;
    }

    /* INPUT DATA layout */
    #tab-input table {
      min-width: 0;
      width: 100%;
      table-layout: fixed;
    }

    #tab-input th:nth-child(1),
    #tab-input td:nth-child(1) {
      width: 40px;
    }

    #tab-input th:nth-child(2),
    #tab-input td:nth-child(2) {
      width: 45%;
    }

    #tab-input th:nth-child(3),
    #tab-input td:nth-child(3) {
      width: 55%;
    }

    #tab-input th:nth-child(2),
    #tab-input th:nth-child(3) {
      white-space: normal;
    }

    #tab-input td:nth-child(2),
    #tab-input td:nth-child(3) {
      white-space: normal;
      word-break: break-word;
    }

    /* REKAP HARIAN layout */
    #tab-rekap-harian table {
      table-layout: fixed;
    }

    #tab-rekap-harian th:nth-child(1),
    #tab-rekap-harian td:nth-child(1) {
      width: 40px;
    }

    #tab-rekap-harian th:nth-child(2),
    #tab-rekap-harian td:nth-child(2) {
      width: 45%;
      white-space: normal;
      word-break: break-word;
    }

    #tab-rekap-harian th:nth-child(3),
    #tab-rekap-harian td:nth-child(3) {
      width: 90px;
      text-align: center;
    }

    #tab-rekap-harian th:nth-child(4),
    #tab-rekap-harian td:nth-child(4) {
      white-space: normal;
      word-break: break-word;
    }

    thead {
      background: var(--blue-soft);
    }

    th,
    td {
      padding: 0.8rem 0.7rem;
      font-size: 0.8rem;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: middle;
    }

    th {
      font-weight: 600;
      color: #1f2933;
      white-space: nowrap;
      text-align: center;
      letter-spacing: 0.01em;
    }

    td {
      text-align: left;
    }

    tbody tr:hover {
      background: #eff6ff;
    }

    .col-no {
      width: 40px;
      text-align: center !important;
    }

    .col-kelas,
    .col-nis {
      text-align: center !important;
    }

    #tab-input td:nth-child(3),
    #tab-rekap-harian td:nth-child(4) {
      text-align: center;
    }

    .alasan-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
      background: white;
      outline: none;
      text-align: center;
      transition:
        border-color 0.12s ease,
        box-shadow 0.12s ease,
        background 0.12s ease,
        transform 0.06s ease;
    }

    .alasan-input:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
      transform: translateY(-0.5px);
    }

    .alasan-display {
      min-height: 1.4em;
      cursor: pointer;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      transition: background 0.12s ease, transform 0.06s ease;
      font-size: 0.8rem;
      text-align: center;
      background: rgba(249, 250, 251, 0.9);
    }

    .alasan-display:hover {
      background: #e5e7eb;
      transform: translateY(-0.5px);
    }

    .alasan-display.empty {
      color: var(--gray);
      font-style: italic;
      background: transparent;
    }

    .kelas-badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      background: #e5e7eb;
      padding: 0.16rem 0.55rem;
      font-size: 0.76rem;
      font-weight: 500;
      white-space: nowrap;
    }

    /* ===== BUTTON ROWS / LEGEND ===== */
    .btn-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.7rem;
      gap: 0.7rem;
      flex-wrap: wrap;
    }

    .btn-row-left {
      display: flex;
      justify-content: flex-start;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .btn-row-right {
      display: flex;
      justify-content: flex-end;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .legend {
      font-size: 0.74rem;
      color: var(--gray);
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    .legend-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .footer-note {
      margin-top: 0.55rem;
      font-size: 0.7rem;
      color: var(--gray);
    }

    /* ===== BULANAN (CHART) ===== */
    .monthly-chart-container {
      margin-top: 0.75rem;
      border-radius: var(--radius-lg);
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 0.8rem 0.85rem;
      max-height: 520px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.9) transparent;
    }

    .monthly-chart-container::-webkit-scrollbar {
      width: 7px;
    }

    .monthly-chart-container::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.95);
      border-radius: 999px;
    }

    .chart-section {
      margin-bottom: 0.85rem;
    }

    .chart-section:last-child {
      margin-bottom: 0.2rem;
    }

    .chart-section-title {
      font-size: 0.86rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.3rem;
    }

    .chart-section-sub {
      font-size: 0.75rem;
      color: var(--gray);
      margin-bottom: 0.4rem;
    }

    .chart-row {
      margin-bottom: 0.7rem;
    }

    .chart-row:last-child {
      margin-bottom: 0.2rem;
    }

    .chart-row-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.4rem;
      font-size: 0.8rem;
      margin-bottom: 0.25rem;
    }

    .chart-row-name {
      font-weight: 600;
      color: #111827;
    }

    .chart-row-meta {
      font-size: 0.78rem;
      color: var(--gray);
      white-space: nowrap;
    }

    .chart-bar-track {
      width: 100%;
      height: 18px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      position: relative;
    }

    .chart-bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #2563eb, #4f46e5);
      transition: width 0.3s ease;
    }

    .chart-row-reasons {
      font-size: 0.76rem;
      color: var(--gray);
      margin-top: 0.25rem;
    }

    .chart-row-reasons strong {
      color: #111827;
      font-weight: 500;
    }

    .chart-row-printbar {
      display: none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.72rem;
      color: #111827;
      margin-top: 0.22rem;
    }

    /* ===== TOAST ===== */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 1.4rem;
      transform: translateX(-50%) translateY(8px);
      background: #111827;
      color: #ffffff;
      padding: 0.45rem 1.1rem;
      border-radius: 999px;
      font-size: 0.78rem;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 9999;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast-success {
      background: var(--green);
    }

    .toast-error {
      background: var(--red);
    }

    .toast-info {
      background: #111827;
    }

    .toast-warning {
      background: #f59e0b;
    }

    .toast-neutral {
      background: #4b5563;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 640px) {
      th,
      td {
        padding: 0.55rem 0.45rem;
        font-size: 0.76rem;
      }

      h1 {
        font-size: 1.1rem;
      }

      .subtitle {
        font-size: 0.78rem;
      }

      .filter-row {
        gap: 0.6rem;
      }

      .table-card {
        min-height: 180px;
      }

      .monthly-chart-container {
        max-height: 420px;
      }

      #tab-input th,
      #tab-input td {
        padding: 0.45rem 0.35rem;
        font-size: 0.74rem;
      }
    }

    /* ===== PRINT ===== */
    @media print {
      body {
        padding: 0;
        background: white;
      }
      .tabs,
      #tab-input,
      .footer-note,
      .toast {
        display: none !important;
      }
      .app {
        box-shadow: none;
        border-radius: 0;
        max-width: 100%;
        border: none;
      }
      button {
        display: none !important;
      }
      input[type="date"],
      input[type="month"],
      select {
        border: none;
        background: transparent;
      }

      .monthly-chart-container {
        max-height: none !important;
        overflow: visible !important;
      }

      .chart-bar-track {
        display: none !important;
      }
      .chart-row-printbar {
        display: block;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- HEADER -->
    <header class="header-box">
      <div class="header-inner">
        <div class="header-main">
          <div class="header-title-row">
            <div class="header-icon">üìä</div>
            <div>
              <h1>Rekap Santri Sakit</h1>
              <p class="subtitle">
                Input laporan santri sakit harian, rekap per tanggal, dan analisis frekuensi bulanan dalam satu aplikasi.
              </p>
            </div>
          </div>
        </div>
        <div class="header-side">
          <div class="stat-chip-row">
            <div class="stat-chip">
              <span>üìÖ</span>
              <strong>Rekap Harian</strong>
            </div>
            <div class="stat-chip">
              <span>üìà</span>
              <strong>Tren Bulanan</strong>
            </div>
          </div>
          <div class="stat-chip-row" style="margin-top:0.1rem;">
            <div class="stat-chip">
              <span>‚úèÔ∏è</span>
              <span>Alasan sakit bisa diedit ulang.</span>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- NAV TABS -->
    <nav class="tabs">
      <button class="tab-btn active" data-tab="input">Input Data</button>
      <button class="tab-btn" data-tab="rekap-harian">Rekap Harian</button>
      <button class="tab-btn" data-tab="rekap-bulanan">Rekap Bulanan</button>
    </nav>

    <!-- =============== TAB INPUT DATA =============== -->
    <section id="tab-input" class="tab-content">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Filter Kelas & Tanggal</div>
          <div class="panel-caption">Pilih tanggal dan kombinasi kelas yang akan diinput laporannya.</div>
        </div>

        <!-- Baris 1: hanya tanggal -->
        <div class="filter-row">
          <div class="field">
            <label for="inputTanggal">Tanggal</label>
            <input type="date" id="inputTanggal" />
          </div>
        </div>

        <!-- Baris 2: jenjang, kelas, jurusan, paralel -->
        <div class="filter-row">
          <!-- Jenjang -->
          <div class="field">
            <label for="inputJenjang">Jenjang</label>
            <input type="hidden" id="inputJenjang" value="MTs" />
            <div class="chip-group" data-target="inputJenjang">
              <button type="button" class="chip-option active" data-value="MTs">MTs</button>
              <button type="button" class="chip-option" data-value="MA">MA</button>
            </div>
          </div>

          <!-- Kelas -->
          <div class="field">
            <label for="inputKelas">Kelas</label>
            <input type="hidden" id="inputKelas" value="VII" />
            <div class="chip-group" data-target="inputKelas">
              <button type="button" class="chip-option active" data-value="VII">VII</button>
              <button type="button" class="chip-option" data-value="VIII">VIII</button>
              <button type="button" class="chip-option" data-value="IX">IX</button>
              <button type="button" class="chip-option" data-value="X">X</button>
              <button type="button" class="chip-option" data-value="XI">XI</button>
              <button type="button" class="chip-option" data-value="XII">XII</button>
            </div>
          </div>

          <!-- Jurusan -->
          <div class="field">
            <label for="inputJurusan">Jurusan</label>
            <input type="hidden" id="inputJurusan" value="IPA" />
            <div class="chip-group" data-target="inputJurusan">
              <button type="button" class="chip-option active" data-value="IPA">IPA</button>
              <button type="button" class="chip-option" data-value="IPS">IPS</button>
              <button type="button" class="chip-option" data-value="-">Umum</button>
            </div>
          </div>

          <!-- Paralel 1-15 (2 baris) -->
          <div class="field">
            <label for="inputParalel">Paralel</label>
            <input type="hidden" id="inputParalel" value="1" />
            <div class="chip-group" data-target="inputParalel" style="max-width:280px;">
              <button type="button" class="chip-option active" data-value="1">1</button>
              <button type="button" class="chip-option" data-value="2">2</button>
              <button type="button" class="chip-option" data-value="3">3</button>
              <button type="button" class="chip-option" data-value="4">4</button>
              <button type="button" class="chip-option" data-value="5">5</button>
              <button type="button" class="chip-option" data-value="6">6</button>
              <button type="button" class="chip-option" data-value="7">7</button>
              <button type="button" class="chip-option" data-value="8">8</button>
              <button type="button" class="chip-option" data-value="9">9</button>
              <button type="button" class="chip-option" data-value="10">10</button>
              <button type="button" class="chip-option" data-value="11">11</button>
              <button type="button" class="chip-option" data-value="12">12</button>
              <button type="button" class="chip-option" data-value="13">13</button>
              <button type="button" class="chip-option" data-value="14">14</button>
              <button type="button" class="chip-option" data-value="15">15</button>
            </div>
          </div>
        </div>

        <div class="btn-row">
          <div class="btn-row-left">
            <button type="button" class="btn-primary" id="btnMuatSantri">
              <span class="icon">üì•</span> Muat Data Santri
            </button>
          </div>
        </div>
      </div>

      <!-- TABEL INPUT -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Daftar Santri & Alasan Sakit</div>
          <div class="panel-caption">Isi kolom <strong>Alasan Sakit</strong> hanya untuk santri yang sakit.</div>
        </div>
        <div class="table-container">
          <div class="table-card">
            <div class="table-scroll">
              <table>
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Nama Santri</th>
                    <th>Alasan Sakit</th>
                  </tr>
                </thead>
                <tbody id="tbodyInput">
                  <!-- rows by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="btn-row" style="margin-top:0.8rem;">
          <div class="btn-row-right" style="width:100%; justify-content:flex-end;">
            <button type="button" class="btn-secondary" id="btnSimpanLaporan">
              <span class="icon">üíæ</span> Simpan Laporan
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- =============== TAB REKAP HARIAN =============== -->
    <section id="tab-rekap-harian" class="tab-content hidden">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Filter Rekap Harian</div>
          <div class="panel-caption">Pilih tanggal dan kelas untuk melihat rekap santri sakit.</div>
        </div>

        <div class="filter-row">
          <div class="field">
            <label for="rekapTanggal">Tanggal</label>
            <input type="date" id="rekapTanggal" />
          </div>
          <div class="field">
            <label for="rekapJenjang">Jenjang</label>
            <select id="rekapJenjang">
              <option value="">Semua</option>
              <option value="MTs">MTs</option>
              <option value="MA">MA</option>
            </select>
          </div>
          <div class="field">
            <label for="rekapKelas">Kelas (opsional)</label>
            <input type="text" id="rekapKelas" placeholder="misal: VIII IPA 1" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button type="button" class="btn-primary" id="btnLoadRekapHarian">
              <span class="icon">üîç</span> Tampilkan Rekap
            </button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Rekap Santri Sakit Harian</div>
          <div class="panel-caption">Daftar santri sakit pada tanggal terpilih. Alasan bisa diedit lalu disimpan ulang.</div>
        </div>
        <div class="table-container">
          <div class="table-card" id="rekapHarianTableWrapper">
            <div class="table-scroll">
              <table>
                <thead>
                  <tr>
                    <th class="col-no">No</th>
                    <th>Nama Santri</th>
                    <th class="col-kelas">Kelas</th>
                    <th>Alasan Sakit</th>
                  </tr>
                </thead>
                <tbody id="tbodyRekapHarian">
                  <!-- rows by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="btn-row" style="margin-top:0.8rem;">
          <div class="btn-row-left">
            <button type="button" class="btn-primary" id="btnDownloadRekapHarianPdf">
              <span class="icon">üìÑ</span> Download PDF
            </button>
          </div>
          <div class="btn-row-right">
            <button type="button" class="btn-secondary" id="btnSimpanPerubahanHarian">
              <span class="icon">üíæ</span> Simpan Perubahan
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- =============== TAB REKAP BULANAN =============== -->
    <section id="tab-rekap-bulanan" class="tab-content hidden">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Filter Rekap Bulanan</div>
          <div class="panel-caption">Pilih bulan dan jenjang untuk melihat tren santri sakit dan kelas dengan frekuensi sakit terbanyak.</div>
        </div>
        <div class="filter-row filter-row-center">
          <div class="filter-row-center-inner">
            <div class="field">
              <label for="bulanRekap">Bulan</label>
              <input type="month" id="bulanRekap" />
            </div>
            <div class="field">
              <label for="bulanJenjang">Jenjang</label>
              <select id="bulanJenjang">
                <option value="">Semua</option>
                <option value="MTs">MTs</option>
                <option value="MA">MA</option>
              </select>
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button type="button" class="btn-primary" id="btnLoadRekapBulanan">
                <span class="icon">üìä</span> Tampilkan Diagram
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Diagram Frekuensi Bulanan</div>
          <div class="panel-caption">
            Menampilkan santri dengan frekuensi sakit terbanyak dan kelas dengan frekuensi sakit terbanyak pada bulan terpilih.
          </div>
        </div>

        <div id="monthlyChartContainer" class="monthly-chart-container">
          <!-- Dua diagram (santri & kelas) diisi via JS -->
        </div>

        <!-- TOMBOL DOWNLOAD PDF DI BAWAH KEDUA DIAGRAM -->
        <div class="btn-row" style="margin-top:0.85rem;">
          <div class="btn-row-left">
            <button type="button" class="btn-primary" id="btnDownloadRekapBulananPdf">
              <span class="icon">üìÑ</span> Download PDF
            </button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ====== SUPABASE INIT (sesuaikan dengan project-mu) ======
    const SUPABASE_URL = "https://YOUR-PROJECT-ID.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR-ANON-KEY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function showToast(message, type = "info") {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = "toast toast-" + type + " show";
      setTimeout(() => {
        toast.classList.remove("show");
      }, 2500);
    }

    // ====== TAB SWITCHING ======
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabs = {
      "input": document.getElementById("tab-input"),
      "rekap-harian": document.getElementById("tab-rekap-harian"),
      "rekap-bulanan": document.getElementById("tab-rekap-bulanan"),
    };

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-tab");
        tabButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        Object.keys(tabs).forEach((key) => {
          tabs[key].classList.toggle("hidden", key !== target);
        });
      });
    });

    // ====== CHIP GROUP (SET VALUE HIDDEN INPUT) ======
    document.querySelectorAll(".chip-group").forEach((group) => {
      const targetId = group.getAttribute("data-target");
      const hiddenInput = document.getElementById(targetId);
      group.addEventListener("click", (e) => {
        if (e.target.matches(".chip-option")) {
          const value = e.target.getAttribute("data-value");
          hiddenInput.value = value;
          group.querySelectorAll(".chip-option").forEach((btn) => btn.classList.remove("active"));
          e.target.classList.add("active");
        }
      });
    });

    // ====== HELPER: BENTUKKAN LABEL KELAS (kelas + jurusan + paralel) ======
    function buildKelasLabel(kelas, jurusan, paralel) {
      if (jurusan === "-" || jurusan === "" || jurusan === null) {
        return `${kelas} ${paralel}`;
      }
      return `${kelas} ${jurusan} ${paralel}`;
    }

    // ====== INPUT TAB: MUAT DATA SANTRI DARI SUPABASE ======
    const tbodyInput = document.getElementById("tbodyInput");
    const btnMuatSantri = document.getElementById("btnMuatSantri");
    const btnSimpanLaporan = document.getElementById("btnSimpanLaporan");

    async function loadSantriUntukInput() {
      const tanggal = document.getElementById("inputTanggal").value;
      const jenjang = document.getElementById("inputJenjang").value;
      const kelas = document.getElementById("inputKelas").value;
      const jurusan = document.getElementById("inputJurusan").value;
      const paralel = document.getElementById("inputParalel").value;
      if (!tanggal) {
        showToast("Lengkapi tanggal terlebih dahulu.", "warning");
        return;
      }

      const labelKelas = buildKelasLabel(kelas, jurusan, paralel);

      // Contoh ambil dari view/tabel santri_per_kelas
      const { data, error } = await supabase
        .from("santri_per_kelas")
        .select("nis, nama_santri")
        .eq("jenjang", jenjang)
        .eq("kelas_full", labelKelas)
        .order("nama_santri", { ascending: true });

      if (error) {
        console.error(error);
        showToast("Gagal memuat data santri.", "error");
        return;
      }

      tbodyInput.innerHTML = "";
      if (!data || data.length === 0) {
        tbodyInput.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:1rem; font-size:0.8rem; color:var(--gray);">Belum ada data santri untuk kelas ini.</td></tr>`;
        return;
      }

      data.forEach((row, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="col-no">${idx + 1}</td>
          <td>${row.nama_santri}</td>
          <td>
            <input
              type="text"
              class="alasan-input"
              placeholder="isi jika sakit"
              data-nis="${row.nis}"
              data-nama="${row.nama_santri}"
              data-jenjang="${jenjang}"
              data-kelas="${labelKelas}"
            />
          </td>
        `;
        tbodyInput.appendChild(tr);
      });
      showToast("Data santri dimuat.", "success");
    }

    btnMuatSantri.addEventListener("click", loadSantriUntukInput);

    // ====== SIMPAN LAPORAN HARIAN (INSERT KE TABEL) ======
    async function simpanLaporanHarian() {
      const tanggal = document.getElementById("inputTanggal").value;
      if (!tanggal) {
        showToast("Tanggal tidak boleh kosong.", "warning");
        return;
      }
      const inputEls = tbodyInput.querySelectorAll(".alasan-input");
      const rowsToInsert = [];
      inputEls.forEach((el) => {
        const alasan = el.value.trim();
        if (alasan) {
          rowsToInsert.push({
            tanggal,
            jenjang: el.getAttribute("data-jenjang"),
            kelas: el.getAttribute("data-kelas"),
            nis: el.getAttribute("data-nis"),
            nama_santri: el.getAttribute("data-nama"),
            alasan,
          });
        }
      });

      if (rowsToInsert.length === 0) {
        showToast("Tidak ada santri sakit yang diisi.", "warning");
        return;
      }

      const { error } = await supabase.from("santri_sakit").insert(rowsToInsert);
      if (error) {
        console.error(error);
        showToast("Gagal menyimpan laporan.", "error");
      } else {
        showToast("Laporan harian tersimpan.", "success");
      }
    }

    btnSimpanLaporan.addEventListener("click", simpanLaporanHarian);

    // ====== REKAP HARIAN: LOAD & EDIT ======
    const tbodyRekapHarian = document.getElementById("tbodyRekapHarian");
    const btnLoadRekapHarian = document.getElementById("btnLoadRekapHarian");
    const btnSimpanPerubahanHarian = document.getElementById("btnSimpanPerubahanHarian");

    async function loadRekapHarian() {
      const tanggal = document.getElementById("rekapTanggal").value;
      const jenjang = document.getElementById("rekapJenjang").value;
      const kelasFilter = document.getElementById("rekapKelas").value.trim();

      if (!tanggal) {
        showToast("Tanggal harus diisi untuk rekap harian.", "warning");
        return;
      }

      let query = supabase.from("santri_sakit").select("*").eq("tanggal", tanggal);
      if (jenjang) query = query.eq("jenjang", jenjang);
      if (kelasFilter) query = query.ilike("kelas", `%${kelasFilter}%`);
      query = query.order("kelas", { ascending: true }).order("nama_santri", { ascending: true });

      const { data, error } = await query;
      if (error) {
        console.error(error);
        showToast("Gagal memuat rekap harian.", "error");
        return;
      }

      tbodyRekapHarian.innerHTML = "";
      if (!data || data.length === 0) {
        tbodyRekapHarian.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:1rem; font-size:0.8rem; color:var(--gray);">Belum ada santri sakit pada tanggal ini.</td></tr>`;
        return;
      }

      data.forEach((row, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="col-no">${idx + 1}</td>
          <td>${row.nama_santri}</td>
          <td class="col-kelas">${row.kelas || "-"}</td>
          <td>
            <input
              type="text"
              class="alasan-input"
              value="${row.alasan || ""}"
              data-id="${row.id}"
            />
          </td>
        `;
        tbodyRekapHarian.appendChild(tr);
      });
      showToast("Rekap harian dimuat.", "success");
    }

    btnLoadRekapHarian.addEventListener("click", loadRekapHarian);

    async function simpanPerubahanRekapHarian() {
      const inputs = tbodyRekapHarian.querySelectorAll(".alasan-input");
      const updates = [];
      inputs.forEach((input) => {
        const id = input.getAttribute("data-id");
        const alasan = input.value.trim();
        updates.push({ id, alasan });
      });

      for (const row of updates) {
        const { error } = await supabase
          .from("santri_sakit")
          .update({ alasan: row.alasan })
          .eq("id", row.id);
        if (error) {
          console.error(error);
          showToast("Sebagian perubahan gagal disimpan.", "error");
          return;
        }
      }
      showToast("Perubahan alasan tersimpan.", "success");
    }

    btnSimpanPerubahanHarian.addEventListener("click", simpanPerubahanRekapHarian);

    // ====== REKAP BULANAN: DIAGRAM SANTRI & KELAS ======
    const btnLoadRekapBulanan = document.getElementById("btnLoadRekapBulanan");
    const monthlyChartContainer = document.getElementById("monthlyChartContainer");

    function buildMonthlySummaries(rows) {
      // per santri
      const perSantriMap = new Map();
      // per kelas
      const perKelasMap = new Map();

      rows.forEach((row) => {
        const kls = row.kelas || "-";
        // per santri (key: nama||kelas)
        const keySantri = `${row.nama_santri || "Tanpa Nama"}||${kls}`;
        if (!perSantriMap.has(keySantri)) {
          perSantriMap.set(keySantri, {
            nama: row.nama_santri || "Tanpa Nama",
            kelas: kls,
            total: 0,
            alasanMap: new Map(),
          });
        }
        const sEntry = perSantriMap.get(keySantri);
        sEntry.total += 1;
        const alasan = (row.alasan || "tidak diisi").trim();
        sEntry.alasanMap.set(alasan, (sEntry.alasanMap.get(alasan) || 0) + 1);

        // per kelas
        if (!perKelasMap.has(kls)) {
          perKelasMap.set(kls, { kelas: kls, total: 0 });
        }
        const kEntry = perKelasMap.get(kls);
        kEntry.total += 1;
      });

      const perSantri = Array.from(perSantriMap.values())
        .sort((a, b) => b.total - a.total)
        .slice(0, 15);

      const perKelas = Array.from(perKelasMap.values())
        .sort((a, b) => b.total - a.total)
        .slice(0, 15);

      return { perSantri, perKelas };
    }

    function renderMonthlyCharts(rows, bulanLabel) {
      monthlyChartContainer.innerHTML = "";

      if (!rows || rows.length === 0) {
        monthlyChartContainer.innerHTML = `<div style="font-size:0.8rem; color:var(--gray); padding:0.4rem 0;">Belum ada data santri sakit pada bulan ini.</div>`;
        return;
      }

      const { perSantri, perKelas } = buildMonthlySummaries(rows);
      const maxSantri = perSantri.length > 0 ? perSantri[0].total : 1;
      const maxKelas = perKelas.length > 0 ? perKelas[0].total : 1;

      // ==== SECTION 1: SANTRI ====
      const sectionSantri = document.createElement("div");
      sectionSantri.className = "chart-section";
      sectionSantri.innerHTML = `
        <div class="chart-section-title">Santri dengan Frekuensi Sakit Terbanyak</div>
        <div class="chart-section-sub">Top ${perSantri.length} santri pada ${bulanLabel}.</div>
      `;
      perSantri.forEach((item) => {
        const barWidth = (item.total / maxSantri) * 100;
        const alasanDetail = Array.from(item.alasanMap.entries())
          .sort((a, b) => b[1] - a[1])
          .map(([alasan, jml]) => `${alasan} (${jml}x)`)
          .slice(0, 3)
          .join(", ");

        const row = document.createElement("div");
        row.className = "chart-row";
        row.innerHTML = `
          <div class="chart-row-header">
            <div class="chart-row-name">${item.nama}</div>
            <div class="chart-row-meta">${item.kelas} ‚Ä¢ ${item.total}x sakit</div>
          </div>
          <div class="chart-bar-track">
            <div class="chart-bar-fill" style="width:${barWidth}%;"></div>
          </div>
          ${
            alasanDetail
              ? `<div class="chart-row-reasons"><strong>Alasan dominan:</strong> ${alasanDetail}</div>`
              : ""
          }
          <div class="chart-row-printbar">
            ${item.nama} (${item.kelas}) ‚Üí ${item.total}x sakit. ${alasanDetail ? "Alasan: " + alasanDetail : ""}
          </div>
        `;
        sectionSantri.appendChild(row);
      });
      monthlyChartContainer.appendChild(sectionSantri);

      // ==== SECTION 2: KELAS ====
      const sectionKelas = document.createElement("div");
      sectionKelas.className = "chart-section";
      sectionKelas.innerHTML = `
        <div class="chart-section-title">Kelas dengan Frekuensi Sakit Terbanyak</div>
        <div class="chart-section-sub">Top ${perKelas.length} kelas pada ${bulanLabel}.</div>
      `;
      perKelas.forEach((item) => {
        const barWidth = (item.total / maxKelas) * 100;
        const row = document.createElement("div");
        row.className = "chart-row";
        row.innerHTML = `
          <div class="chart-row-header">
            <div class="chart-row-name">${item.kelas}</div>
            <div class="chart-row-meta">${item.total}x sakit</div>
          </div>
          <div class="chart-bar-track">
            <div class="chart-bar-fill" style="width:${barWidth}%;"></div>
          </div>
          <div class="chart-row-printbar">
            Kelas ${item.kelas} ‚Üí ${item.total}x sakit.
          </div>
        `;
        sectionKelas.appendChild(row);
      });
      monthlyChartContainer.appendChild(sectionKelas);
    }

    async function loadRekapBulanan() {
      const bulanValue = document.getElementById("bulanRekap").value;
      const jenjang = document.getElementById("bulanJenjang").value;
      if (!bulanValue) {
        showToast("Bulan rekap belum dipilih.", "warning");
        return;
      }

      // bulanValue format: YYYY-MM
      const [year, month] = bulanValue.split("-");
      const startDate = `${year}-${month}-01`;
      const endDate = `${year}-${month}-31`;

      let query = supabase
        .from("santri_sakit")
        .select("*")
        .gte("tanggal", startDate)
        .lte("tanggal", endDate);

      if (jenjang) query = query.eq("jenjang", jenjang);

      const { data, error } = await query;
      if (error) {
        console.error(error);
        showToast("Gagal memuat rekap bulanan.", "error");
        return;
      }

      const bulanLabel = new Date(startDate).toLocaleDateString("id-ID", {
        month: "long",
        year: "numeric",
      });

      renderMonthlyCharts(data || [], bulanLabel);
      showToast("Rekap bulanan dimuat.", "success");
    }

    btnLoadRekap
